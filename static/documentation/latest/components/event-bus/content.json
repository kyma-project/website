{
  "id": "event-bus",
  "displayName": "Event Bus",
  "description": "Overal documentation for Event Bus",
  "type": "Components",
  "docs": [
    {
      "order": "001-overview-event-bus",
      "title": "Overview",
      "type": "Overview",
      "source": "<p>Kyma Event Bus enables the integration of various external solutions with Kyma. The integration is achieved using the <code>publish-subscribe</code> messaging pattern that allows Kyma to receive business Events from different solutions, enrich them, and trigger business flows using lambdas or services defined in Kyma.</p>\n<blockquote>\n<p><strong>NOTE:</strong> The Event Bus is based on the <a href=\"https://github.com/nats-io/nats-streaming-server/releases\" target=\"_blank\">NATS Streaming</a> open source log-based streaming system for cloud-native applications, which is a brokered messaging middleware. The Event Bus provides <strong>at-least-once</strong> delivery guarantees.</p>\n</blockquote>\n"
    },
    {
      "order": "010-details-concepts",
      "title": "Basic concepts",
      "type": "Details",
      "source": "<p>The following resources are involved in Event transfer and validation in Kyma:</p>\n<ul>\n<li><p><strong>EventActivation</strong> is a custom resource controller that the Remote Environment Broker (REB) creates. Its purpose is to define Event availability in a given Environment.</p>\n</li>\n<li><p><strong>NATS Streaming</strong> is an open source, log-based streaming system that serves as a database allowing the Event Bus to store and transfer the Events on a large scale.</p>\n</li>\n<li><p><strong>Persistence</strong> is a back-end storage volume for NATS Streaming that stores Events. When the Event flow fails, the Event Bus can resume the process using the Events saved in Persistence.</p>\n</li>\n<li><p><strong>Publish</strong> is an internal Event Bus service that transfers the enriched Event from a given external solution to NATS Streaming.</p>\n</li>\n<li><p><strong>Push</strong> is an application responsible for receiving Events from NATS Streaming in the Event Bus. Additionally, it delivers the validated Events to the lambda or the service, following the trigger from the Subscription custom resource. The Events are delivered to the lambda or the service through the Envoy proxy sidecar with mTLS enabled.</p>\n</li>\n<li><p><strong>Subscription</strong> is a custom resource that the lambda or service creator defines to subscribe a given lambda or a service to particular types of Events.</p>\n</li>\n<li><p><strong>Sub-validator</strong> is a Kubernetes deployment. It updates the status of the Subscription custom resource with the EventActivation status. Depending on the status, <code>push</code> starts or stops delivering Events to the lambda or the service webhook.</p>\n</li>\n</ul>\n"
    },
    {
      "order": "011-details-event-flow-requirements",
      "title": "Event flow requirements",
      "type": "Details",
      "source": "<p>The Event Bus enables a successful flow of the Events in Kyma when:</p>\n<ul>\n<li>The <a href=\"#activate-events\">EventActivation</a> is in place.</li>\n<li>You create a <a href=\"#consume-events\">Subscription</a> Kubernetes custom resource and register the webhook for the lambda or a service to consume the Events.</li>\n<li>The Events are <a href=\"#event-publishing\">published</a>.</li>\n</ul>\n<h2 id=\"details\">Details</h2>\n<p>See the following subsections for details on each requirement.</p>\n<h3 id=\"activate-events\">Activate Events</h3>\n<p>To receive Events, use EventActivation between the Environment and the Remote Environment.</p>\n<p>For example, if you define the lambda in the <code>test123</code> Environment and want to receive the <code>order-created</code> Event type from the <code>ec-qa</code> Remote Environment, you need to enable the EventActivation between the <code>test123</code> Environment and the <code>ec-qa</code> Remote Environment. Otherwise, the lambda cannot receive the <code>order-created</code> Event type.</p>\n<p><img src=\"assets/event-activation.png\" alt=\"EventActivation.png\"></p>\n<h3 id=\"consume-events\">Consume Events</h3>\n<p>Enable lambdas and services to consume Events in Kyma between any Environment and the Remote Environment using <code>push</code>. Deliver Events to the lambda or the service by registering a webhook for it. Create a Subscription Kubernetes custom resource to register the webhook.</p>\n<p>See the table for the explanation of parameters in the Subscription custom resource.</p>\n<table>\n<thead>\n<tr>\n<th>Parameter</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>include_subscription_name_header</strong></td>\n<td>It indicates whether the lambda or the service includes the name of the Subscription when receiving an Event.</td>\n</tr>\n<tr>\n<td><strong>include_topic_header</strong></td>\n<td>It indicates whether the service or app includes the name of the topic when receiving an Event.</td>\n</tr>\n<tr>\n<td><strong>max_inflight</strong></td>\n<td>It indicates the maximum number of Events which can be delivered concurrently. The final value is the <strong>max_inflight</strong> number multiplied by the number of the <code>push</code> applications.</td>\n</tr>\n<tr>\n<td><strong>push_request_timeout_ms</strong></td>\n<td>It indicates the time for which the <code>push</code> waits for the response when delivering an Event to the lambda or the service. After the specified time passes, the request times out and the Event Bus retries delivering the Event. Setting the <strong>minimum</strong> parameter to <code>0</code> applies the default value of 1000ms.</td>\n</tr>\n<tr>\n<td><strong>event_type</strong></td>\n<td>The name of the Event type. For example, <code>order-created</code>.</td>\n</tr>\n<tr>\n<td><strong>event_type_version</strong></td>\n<td>The version of the Event type. For example, <code>v1</code>.</td>\n</tr>\n<tr>\n<td><strong>source</strong></td>\n<td>Details of the remote environment that the Event originates from.</td>\n</tr>\n<tr>\n<td><strong>source_environment</strong></td>\n<td>The environment of the Event source. For example, <code>ec-qa</code>.</td>\n</tr>\n<tr>\n<td><strong>source_namespace</strong></td>\n<td>The parameter that uniquely identifies the organization publishing the Event.</td>\n</tr>\n<tr>\n<td><strong>source_type</strong></td>\n<td>The type of the Event source. For example, <code>commerce</code>.</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"event-publishing\">Event publishing</h3>\n<p>Make sure that the external solution sends Events to Kyma.</p>\n"
    },
    {
      "order": "012-details-troubleshooting",
      "title": "Troubleshooting",
      "type": "Details",
      "source": "<ul>\n<li><p>If the lambda or the service does not receive any Events, check the following:</p>\n<ul>\n<li>Confirm that the EventActivation is in place.</li>\n<li>Ensure that the webhook defined for the lambda or the service is up and running.</li>\n<li>Make sure the Events are published.</li>\n</ul>\n</li>\n<li><p>If errors appear while sending Events:</p>\n<ul>\n<li>Check if the <code>publish</code> application is up and running.</li>\n<li>Make sure that NATS Streaming is up and running.</li>\n</ul>\n</li>\n</ul>\n"
    },
    {
      "order": "020-architecture-event-bus",
      "title": "Architecture",
      "type": "Architecture",
      "source": "<p>See the diagram and steps for an overview of the basic Event Bus flow:</p>\n<p><img src=\"assets/event-bus-architecture.png\" alt=\"Event Bus architecture\"></p>\n<h2 id=\"event-flow\">Event flow</h2>\n<ol>\n<li><p>The external solution integrated with Kyma makes a REST API call to the Application Connector to indicate that a new Event is available.</p>\n</li>\n<li><p>The Application Connector enriches the Event with the details of its source.</p>\n</li>\n</ol>\n<blockquote>\n<p><strong>NOTE:</strong> There is always one dedicated instance of the Application Connector for every instance of an external solution connected to Kyma.</p>\n</blockquote>\n<ol>\n<li><p>The Application Connector makes a REST API call to <code>publish</code> and sends the enriched Event.</p>\n</li>\n<li><p><code>publish</code> saves the information in the NATS Streaming database.</p>\n</li>\n<li><p>NATS Streaming stores the Event details in the Persistence storage volume to ensure the data is not lost if the NATS Streaming crashes.</p>\n</li>\n<li><p>If the Subscription <a href=\"#event-validation\">validation process</a> completes successfully, <code>push</code> consumes the Event from NATS Streaming.</p>\n</li>\n<li><p><code>push</code> delivers the Event to the lambda or the service.</p>\n</li>\n</ol>\n<h2 id=\"event-validation\">Event validation</h2>\n<p>The Event Bus performs Event validation before it allows Event consumption.</p>\n<h3 id=\"validation-details\">Validation details</h3>\n<p>When you create a lambda or a service to perform a given business functionality, you also need to define which Events trigger it. Define triggers by creating the Subscription custom resource in which you register with the Event Bus to forward the Events of a particular type, such as <code>order-created</code>, to your lambda or a service. Whenever the <code>order-created</code> Event comes in, the Event Bus consumes it by saving it in NATS Streaming and Persistence, and sends it to the correct receiver specified in the Subscription definition.</p>\n<blockquote>\n<p><strong>NOTE:</strong> The Event Bus creates a separate Event Trigger for each Subscription.</p>\n</blockquote>\n<p>Before the Event Bus forwards the Event to the receiver, the sub-validator performs a security check to verify the permissions for this Event in a given Environment. It reads all new Subscription resources and refers to the EventActivation resource to check whether a particular Event type is enabled in a given Environment. If the Event is enabled for an Environment, it updates the Subscription resource with the information. Based on the information, <code>push</code> sends the Event to the lambda or the service.</p>\n<h3 id=\"validation-flow\">Validation flow</h3>\n<p>See the diagram and a step-by-step description of the Event verification process.</p>\n<p><img src=\"assets/event-validation.png\" alt=\"Event validation process\"></p>\n<ol>\n<li>Kyma user defines a lambda or a service.</li>\n<li>Kyma user creates a Subscription custom resource.</li>\n<li>The sub-validator reads the new Subscription.</li>\n<li>The sub-validator refers to the EventActivation resource to check if the Event in the Subscription is activated for the given Environment.</li>\n<li>The sub-validator updates the Subscription resource accordingly.</li>\n</ol>\n"
    },
    {
      "order": "030-cli-reference",
      "title": "CLI reference",
      "type": "CLI reference",
      "source": "<h2 id=\"overview\">Overview</h2>\n<p> Management of the Event Bus is based on the custom resources specifically defined for Kyma. Manage all of these resources through <a href=\"https://kubernetes.io/docs/reference/kubectl/overview/\" target=\"_blank\">kubectl</a>.</p>\n<h2 id=\"details\">Details</h2>\n<p>This section describes the resource names to use in the kubectl command line, the command syntax, and examples of use.</p>\n<h3 id=\"resource-types\">Resource types</h3>\n<p>Event Bus operations use the following resources:</p>\n<table>\n<thead>\n<tr>\n<th>Singular name</th>\n<th>Plural name</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>subscription</td>\n<td>subscriptions</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"syntax\">Syntax</h3>\n<p>Follow the <code>kubectl</code> syntax, <code>kubectl {command} {type} {name} {flags}</code>, where:</p>\n<ul>\n<li>{command} is any command, such as <code>describe</code>.</li>\n<li>{type} is a resource type, such as <code>clusterserviceclass</code>.</li>\n<li>{name} is the name of a given resource type. Use {name} to make the command return the details of a given resource.</li>\n<li>{flags} specifies the scope of the information. For example, use flags to define the Namespace from which to get the information.</li>\n</ul>\n<h3 id=\"examples\">Examples</h3>\n<p>The following examples show how to create new Subscriptions, list them, and obtain detailed information on their statuses.</p>\n<ul>\n<li>Create a new Subscription directly from the terminal:</li>\n</ul>\n<pre><code>   cat &lt;&lt;EOF | kubectl create -f -\n   apiVersion: eventing.kyma.cx/v1alpha1\n   kind: Subscription\n   metadata:\n     name: my-subscription\n     namespace: stage\n   spec:\n     endpoint: http://testjs.default:8080/\n     push_request_timeout_ms: 2000\n     max_inflight: 400\n     include_subscription_name_header: true\n     include_topic_header: true\n     event_type: order_created\n     event_type_version: v1\n     source:\n       source_namespace: com.github\n       source_type: commerce\n       source_environment: stage\nEOF\n</code></pre><ul>\n<li>Get the list of all Subscriptions:</li>\n</ul>\n<pre><code>kubectl get subscription --all-namespaces\n</code></pre><ul>\n<li>Get the list of all Subscriptions with detailed information on the Subscription status:</li>\n</ul>\n<pre><code>kubectl get subscriptions -n stage -o=custom-columns=NAME:.metadata.name,STATUS:.status.conditions[*].status,STATUS TYPE:.status.conditions[*].type\n</code></pre>"
    }
  ]
}
